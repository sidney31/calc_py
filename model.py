import math
import re

class Model:

    def __init__(self) -> None:
        self.res = ""
        self.h = { #ÑĞ»Ğ¾Ğ²Ğ°Ñ€ÑŒ, Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµÑ‚ ĞºĞ»ÑÑ‡ Ğ² ÑÑ‚Ñ€Ğ¾ĞºĞµ
            "Ã—": "*", 
            "Ã·": "/", 
            "âˆš": "math.sqrt(",
            "e": "math.e",
            "Ï€": "math.pi",
            "!": "math.factorial(",
            "sin": "math.sin(math.radians(",
            "cos": "math.cos(math.radians(",
            "tan": "math.tan(math.radians(",
            "lg": "math.log10(",
            "ln": "self.loge(",
            "d_sqrt": "self.d_sqrt",
                  }

    def d_sqrt(self, base, degree): # Ğ´Ğ»Ñ ÑÑ‚ĞµĞ¿ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ñ€Ğ½Ñ
        return pow(base, 1/degree)

    def loge(self, num): # Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ°Ñ€Ğ¸Ñ„Ğ¼Ğ° Ğ¿Ğ¾ Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğµ
        return math.log(num, math.e)

    def CalcPercent(self, result): #Ğ³Ğ¾Ğ²Ğ½Ğ¾-ĞºĞ¾Ğ´, Ğ½Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
        #ĞºĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ try-except Ğ½ÑƒĞ¶Ğ½Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ¾Ğ²Ğ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº, Ğ² ÑĞ»ÑƒÑ‡Ğ°Ğµ ĞµÑĞ»Ğ¸ Ğ² Ğ±Ğ»Ğ¾ĞºĞµ try Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ½ĞµÑ‚ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°, Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Ğ½Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑÑ ğŸ‘
        try:
            expression = re.search(r"\d+.\d+%", result).group(0) #Ñ€ĞµĞ³ÑƒĞ»ÑÑ€ĞºĞ° Ğ´Ğ»Ñ Ğ½Ğ°Ğ´Ğ¾
            result = result.replace(expression, "")

            signs = "+-*/"

            for sign in signs: # Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸Ğ½Ğ´ĞµĞºÑĞ° Ğ·Ğ½Ğ°ĞºĞ°
                try:
                    SignIndex = expression.index(sign)
                except:
                    pass
            
            if (SignIndex == None):
                return False
            
            #Ğ¸Ğ¼ĞµÑ Ğ¸Ğ½Ğ´ĞµĞºÑ Ğ·Ğ½Ğ°ĞºĞ° Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ´Ğ²ÑƒĞ¼Ñ Ñ‡Ğ¸ÑĞ»Ğ°Ğ¼Ğ¸, Ğ¼Ğ¾Ğ¶ĞµĞ¼ Ğ²Ñ‹Ñ‚Ğ°Ñ‰Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¸ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ 
            #Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: ĞµÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ 5-50%; Ñƒ Ğ½Ğ°Ñ ĞµÑÑ‚ÑŒ Ğ¸Ğ½Ğ´ĞµĞºÑ Ğ·Ğ½Ğ°ĞºĞ° Ğ¼Ğ¸Ğ½ÑƒÑĞ° - 1, 
            #Ğ²ÑĞµ Ñ‡Ñ‚Ğ¾ Ğ´Ğ¾ Ğ¼Ğ¸Ğ½ÑƒÑĞ°, ÑÑ‚Ğ¾ Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾, Ğ²ÑĞµ Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¼Ğ¸Ğ½ÑƒÑĞ° - ÑÑ‚Ğ¾ Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾

            base = expression[:SignIndex] 
            percent = expression[SignIndex+1:-1]
            sign = expression[SignIndex]

            #Ğ¿Ğ¾Ğ´ÑÑ‚Ğ°Ğ²ÑĞ»ĞµĞ¼ Ñ‡Ğ¸ÑĞ»Ğ° Ğ² Ñ„Ğ¾Ñ€Ğ¼ÑƒĞ»Ñƒ (50 * 5 / 100), Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ 50 Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¾Ñ‚ 5
            #Ğ¸ Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ²Ñ‹Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ÑÑ‚Ğ¾ Ğ¸Ğ· 50
            result += str(f"{float(base)} {sign} {float(percent)} * {float(base)} / 100")
        except:
            pass

        return result

    def ParseResult(self, result):

        #Ğ¿ĞµÑ€ĞµĞ±Ğ¾Ñ€ ÑĞ»Ğ¾Ğ²Ğ°Ñ€Ñ, Ğ¸ Ğ·Ğ°Ğ¼ĞµĞ½Ğ° Ğ² Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğµ ĞºĞ»ÑÑ‡ĞµĞ¹ Ğ½Ğ° Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°  
        for key in self.h.keys():
            result = result.replace(key, self.h[key])

        if self.CalcPercent(result) == False:
            return

        #Ğ½Ğ¸Ğ¶Ğµ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ¿Ğ¾Ğ´ÑÑ‡ĞµÑ‚ ÑĞºĞ¾Ğ±Ğ¾Ğº, ĞµÑĞ»Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ÑÑ‰Ğ¸Ñ…ÑÑ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ, 
        #Ñ‡ĞµĞ¼ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ÑÑ‰Ğ¸Ñ…ÑÑ, Ñ‚Ğ¾ Ğ¸Ñ… ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ²Ñ‹Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ, 
        #Ğ¿ÑƒÑ‚ĞµĞ¼ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ÑÑ‰Ğ¸Ñ…ÑÑ ÑĞºĞ¾Ğ±Ğ¾Ğº Ğ² ĞºĞ¾Ğ½ĞµÑ† ÑÑ‚Ñ€Ğ¾ĞºĞ¸

        OpenBrakes = 0
        CloseBrakes = 0

        for i in result:
            if i == "(":
                OpenBrakes+=1
            if i == ")":
                CloseBrakes+= 1

        for i in range(OpenBrakes-CloseBrakes):
            result += ")";

        return result


    def computation(self, button): #Ñ‚ÑƒÑ‚ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ÑÑ, Ñ‡Ñ‚Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ğ¸ Ñ‚Ğ¾Ğ¹ Ğ¸Ğ»Ğ¸ Ğ¸Ğ½Ğ¾Ğ¹ ĞºĞ»Ğ°Ğ²Ğ¸ÑˆĞ¸
        if button == "C": #Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ğ¸ Ğ½Ğ° Ğ¡ 
            self.res = "" #Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ, Ñ…Ñ€Ğ°Ğ½ÑÑ‰Ğ°Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€/Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ğ±Ğ½ÑƒĞ»ĞµĞ½Ğ° 
        elif button == "â†": # Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ğ¸ Ğ½Ğ° ÑÑ‚Ñ€ĞµĞ»Ğ¾Ñ‡ĞºÑƒ
            if self.res == "error":
                self.res = ""
            else:
                self.res = str(self.res)
                self.res = self.res[:len(self.res)-1] #Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ Ğ±ÑƒĞ´ĞµÑ‚ ÑƒĞºĞ¾Ñ€Ğ¾Ñ‡ĞµĞ½Ğ° Ğ½Ğ° Ğ¾Ğ´Ğ¸Ğ½ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ» ÑĞ·Ğ°Ğ´Ğ¸, Ğ¿ÑƒÑ‚ĞµĞ¼ Ğ·Ğ°Ğ¼ĞµĞ½Ñ‹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ½Ğ° ĞµĞµ ÑÑ€ĞµĞ· Ñ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ° Ğ´Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾
        elif isinstance(button, int) or button == "00": #ĞµÑĞ»Ğ¸ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ°Ñ ĞºĞ»Ğ°Ğ²Ğ¸ÑˆĞ° Ñ€Ğ°Ğ²Ğ½Ğ° 00 Ğ¸Ğ»Ğ¸ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ ÑĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€Ğ¾Ğ¼ ĞºĞ»Ğ°ÑÑĞ° int, Ñ‚.Ğµ. ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ñ†ĞµĞ»Ñ‹Ğ¼ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼
            self.res += str(button) #Ñ‚Ğ¾ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ ĞºĞ»Ğ°Ğ²Ğ¸ÑˆĞ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ² Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
        elif button in "- + Ã— Ã· , ( ) âˆš e Ï€ ! % sin cos tan lg ln".split(): #ĞµÑĞ»Ğ¸ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ° Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº
            self.res+=button #Ñ‚Ğ¾ ĞµĞµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ² Ğ¿Ğ¾Ğ»Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ° 
            # Ğ½Ğ¸Ğ¶Ğµ Ğ²ÑĞµ Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾
        elif button == "xÂ²":
            self.res+="**2"
        elif button == "xÊ¸":
            self.res+="**"
        elif button == "Ê¸âˆšx":
            self.res+="d_sqrt("
        elif button == "=": 
            try: #Ğ¾Ñ‚Ğ»Ğ¾Ğ² Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
                self.res = str(eval(self.ParseResult(self.res))) #Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ° Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµÑ‚ÑÑ Ğ² Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ "ParseResult", Ğ² ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğµ Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ğ°.
                                                                 #Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ÑÑ, Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ² ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ¸ Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµÑ‚ÑÑ Ğ² Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
            except:
                self.res = "error"

        # if self.res[-2:] == ".0": #Ğ¾ĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ»Ğ¾Ğ³Ğ¾ Ñ‡Ğ¸ÑĞ»Ğ° Ğº int (4.0 -> 4)
        #     self.res = str(int(self.res))

        return str(self.res)
    
    
